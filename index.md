# **Dye color forecast**
## 关于染发结果的数学物理模型

## Part 1 色素与头发的结合
### 1.1 假设
- 发丝与色素分子的结合方式基于氨基酸裸露R基与色素分子的相互作用，包括但不限于*氢键*、*范德瓦耳斯力*等
- 色素分子与色素分子之间的相互作用力远弱于头发与色素分子之间，换而言之，我们认为结合在头发上的*色素分子难以形成多层堆叠的结构*
- 染发时，头发*完全浸润*在染液中，且*实验条件下不足以使染液浓度产生明显变化*
### 1.2 数学物理模型
<img src= pics\model_1.jpg width="100%">

如图所示，我们设单位面积上色素覆盖率为x，色素分子与头发上的分子之间结合和解离的的速率常数分别为k<sub>1</sub>、k<sub>2</sub>；类似的，已结合在头发表层的色素与游离色素分子之间结合和解离的速率常数分别为k<sub>3</sub>、k<sub>4</sub>。需要说明的是，b的实际意义存在争议，但它一定是一个表征表面颜色深浅的强度量，可以表示为表面色素的厚度、表面色素的分子数密度等等，这取决于是采用连续模型还是晶格镶嵌模型理解这一过程。我们倾向于使用晶格镶嵌模型。

总而言之，存在以下两条途径:
$$
        \ce{Pigment_{(free)} <=>[k_1][k_2]  
        {\ce{Pigment-Hair}}}\tag{1.1}
$$
$$
        \ce{Pigment_{(free)} <=>[k_3][k_4]  
        {\ce{Pigment-Pigment}}}\tag{1.2}
$$
反应式(1)实际上给出了覆盖率的变化方程：
$$
        \frac{\mathrm{d} x}{\mathrm{d} t} = k_1\Gamma  x-k_2n_0(1-x)\tag{1.3}
$$
其中，\(\Gamma\)为单位时间内游离色素分子与裸露的头发界面发生碰撞的次数，由热力学可知，其只与*色素分子浓度*、*大小*、*溶液分子*和*温度*有关，因此在实验条件下，为一常数。$n_0$可理解为镶嵌在单位面积上的色素分子数，根据假设，其为一常数，这是因为单个晶格仅有镶嵌和未镶嵌两种状态。

注意，由于无法精确确定各待定常数，因此我们将解写作：

$$x=1-e^{-pt}\tag{*}$$

其中*p*可以从统计学上唯象地认为是单位时间色素分子与裸露的头发分子结合的概率。这一结果在物理上是显然的。

反应式(2)则给出了强度量*b*的变化率方程：
$$
        \frac{\mathrm{d} b}{\mathrm{d} t}=k_3\Gamma x-k_4n_0b\tag{1.4}
$$

同样地，我们将解写作：
$$
        b = b_0(1-e^{-qt}) + b_1({e^{-pt}-e^{-qt}})\tag{**}
$$

## PART 2 染发的视觉效果
### 2.1 色觉形成的原理
<img src= pics\model_2.png width="100%">
以人眼视觉为例，人眼存在L、M、S三种视觉细胞，其对不同波长的光的灵敏度并不相同，因此当光线进入人眼后，三种视觉细胞将根据不同的灵敏度谱进行卷积操作，并向视觉中枢输出三种不同的信号，视觉中枢通过这三个信号的值，即可得到光强和其在色度空间内的坐标。

因此，显而易见，色觉空间是一个三维锥空间，其标量值为强度量，而坐标则对应其色调。注意，无论是反射、透射、吸收；亦或是视觉细胞的“卷积”操作，都是锥空间内的线性变换。

基于此，预先选用照片的RGB值或其他指标作为基矢量不存在任何问题，这仅仅意味着不同的基矢量之间的线性转换。
### 2.2 染发后头发颜色的数学表述
考虑一束光入射到如PART1所展示的头发表面并射入人眼的过程，记入射光为$\vec A_0$,考虑各波长的共享，入射光可记作：

$$
        \vec A_0 = \int_{\Sigma} \vec A_{(\lambda)} d\lambda \tag{2.1}
$$

其中，$\Sigma$为全色觉空间，$\lambda$为光的波长，$\vec A_{(\lambda)}$则是这束光对应单色光的色觉矢量。

这是基于色觉的锥空间属性所允许的运算。

同时，我们可以认为光经历反射透射等过程，进入人眼乃至视觉细胞的光学过程，是若干个线性变换叠加而成，因此，接受系统产生的色觉反馈为：

$$
        \vec A = \int_{\Sigma} \alpha_{(\lambda)} \vec A_{(\lambda)} d\lambda \tag{2.2}
$$

对于单种色素染色，由PART1可知

$$
        \begin{aligned}
        \vec A  &= \vec A_1 +\vec A_2\\
                &= (1-x)\int_{\Sigma} \alpha_{1(\lambda)} \vec A_{(\lambda)} d\lambda + x\int_{\Sigma} \alpha_{2(\lambda)} \vec A_{(\lambda)} d\lambda\\
        \end{aligned} 
$$

根据式(*)

$$
x = 1-e^{-pt}
$$

可知

$$
        \begin{aligned}
        \vec A  &= e^{-pt}\vec A_{hair}+(1-e^{-pt})\vec A_{pigment}\tag{2.3}\\
        \end{aligned}\\
        And \ \vec A_{pigment} \ is\ related\ with\ parament\ b\ in\ (**) 
$$

对于多种色素染色的结果同样可以以此类推，复杂之处在于类似PART1中的模型，将要考虑染色的前后顺序对覆盖率造成的影响，两种色素的情形将会在后文中提及

## PART3 染色结果预测模型的构建

### 3.1 训练集的搜集
我们设置了合适的浓度梯度和时间梯度，采集了不同条件下染色后的头发，并进行拍照。最后根据背景色，对色值进行规范化处理

### 3.2 单色模型结构
将浓度和时间作为输入，仅设置一层隐藏层，三个神经元，激活函数：

$$
        activation = e^{-x}
$$

这一函数的选择是显然的。

### 3.3 混染模型结构
#### 3.3.1 混染模型的数学表述
<img src= pics\model_3.png width="100%">
考虑当第一种色素染色后，面积元内存在两种体系——覆盖在头发上的色素-色素体系和裸露的头发体系。将两种体系都视作类似PART1内的体系，可立刻得到下列描述式:

$$
        \left 
        \{
        \begin{matrix}
        x_1 = 1-e^{-p_1t}\\
        x_2 = 1-e^{-p_2t}\\
        x_{12} = 1-e^{-p_{12}t}\\
        \end{matrix}
        \right.
        \ \ \ \ 
        \left 
        \{
        \begin{matrix}
        b_1 = b_1^0(1-e^{-q_1t}) + b_1^1({e^{-p_1t}-e^{-q_1t}})\\
        b_2= b_2^0(1-e^{-q_2t}) + b_2^1({e^{-p_2t}-e^{-q_2t}})\\
        b_{12}= b_{12}^0(1-e^{-q_{12}t}) + b_{12}^1(e^{-p_{12}t}-e^{-q_{12}t})\\
        \end{matrix}
        \right.
$$

同样地，立即给出色觉表达式：

$$
        \begin{aligned}
        \vec A  &= x_1x_{12}\vec A_{pigment12} + x_1(1-x{12}) \vec A_{pigment1} + x_2(1-x_1) \vec A_{pigment2} + (1-x_1)(1-x_2)\vec A_{hair}\\
        &=(1-e^{-p_1t})[(1-e^{p_{12}t})\vec A_{pigment12}+e^{-p_{12}t}\vec A_{pigment1}]+e^{-p_2t}[(1-e^{-p_2t})\vec A_{pigment2}+e^{-p_2t}\vec A_{hair}]
        \end{aligned}
$$

提前说明，由于在投入使用时，色素溶液的环境为一已知的限制值，因此，诸如$p_1$、$p_2$、$q_1$、$q_2$等参数均为一常数值。

#### 3.3.2 混染模型
step1 根据色素的种类、浓度和染发时间输入3.2中的纯色染发模型，得到两组RGB值

step2 *因采用晶格镶嵌模型* ,我们认为pigment1-pigment2的体系含量极少，因此，对第二组RGB值进行缩放：

$$
        scaling = (1-e^{-8t_2})
$$

其中，$t_2$（单位:\0.5h)指第二次染色时的染色时间，指数8是反复调试过程中选择的的参数

step3 将两组RGB值作为神经网络的输入，设置两层隐藏层，激活函数分别为：

$$
        relu: output = \left 
        \{
        \begin{matrix}
        x\ (if\ x>0)\\
        \ 0\ (if\ x<=0)\\
        \end{matrix}
        \right.\\
        lightrelu:output = \left 
        \{
        \begin{matrix}
        relu(x) \ (if\ x<255)\\
        \ 255\ (if\ x>=255)\\
        \end{matrix}
        \right.\\
$$

第一层隐藏层有15个神经元，激活函数为relu

第二层隐藏层有15个神经元，激活函数为lightrelu

## PART 4 模型的缺点及改进方案
### 4.1 混合染色模型的参数确定
原则来说，根据第一次选用的色素种类不同，在scaling function中选用的指数参数应该有所区别。但是由于神经网络的解释性差，以及稀缺的实验数据，只能将这个scaling过程变成一个tuning过程，并增加模型深度和神经元个数，以期获得范围内较好的拟合结果。

### 4.2 混合染色模型的过拟合问题
这一问题暂无太好的解决方案，一方面是染色本身的特性——并不均匀的染色效果；另一方面是数据集过于小。

但另一方面，过拟合的问题并不重要。只需要在合适范围内，例如[0,30]X[0,30]的取值域内。我们并不建议任何人染发超过一个小时的时间，这并无意义，无论是从类晶体镶嵌模型的假设，还是实验结果而言，足够长的染发时间并不能获得足够浓的色彩，吸附的色素会趋于饱和。

### 4.3 解决方案
解决方案无非两点：

1. 扩增数据集
2. 优化数学模型，例如简化

我们也将持续更新数据集，并对模型进行优化。
